{% extends 'base_generic.html' %}

{% block content %}
    <h1 style="text-align: center; margin-bottom: 20px;">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>

    <style>
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π */
        .listings-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è */
        .listing {
            width: 320px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .listing:hover {
            transform: scale(1.03);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è */
        .listing h2 {
            text-align: center;
            font-size: 18px;
            margin: 15px 10px;
            color: #333;
        }

        /* –ë–ª–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .picture {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0;
        }

        /* –¢–µ–∫—Å—Ç "–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" */
        .picture p {
            color: #888;
            font-size: 14px;
        }

        /* –ß–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç */
        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }
        #chat-toggle {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
        }
        #chat-box {
            width: 300px;
            height: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            position: absolute;
            bottom: 60px;
            right: 0;
            padding: 10px;
            display: none;
        }
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        #chat-input {
            width: 80%;
            padding: 5px;
        }
        #send-message {
            width: 18%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>

    <div class="listings-container">
        {% for listing_info in listings_with_pictures %}
            <a href="{% url 'listing_detail' listing_info.listing.id %}" style="text-decoration: none; color: inherit;">
                <div class="listing">
                    <div class="picture">
                        {% if listing_info.picture %}
                            {% if listing_info.picture.image_base64 %}
                                <img src="data:image/jpeg;base64,{{ listing_info.picture.image_base64 }}"
                                     alt="Listing Picture">
                            {% else %}
                                <img src="{{ listing_info.picture.image.url }}" alt="Listing Picture">
                            {% endif %}
                        {% else %}
                            <p>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                        {% endif %}
                    </div>
                    <h2>{{ listing_info.listing.price }}$ {{ listing_info.listing.rooms }}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</h2>
                </div>
            </a>
        {% endfor %}
    </div>

    <!-- –ß–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç -->
    <div id="chat-container">
        <button id="chat-toggle">üí¨</button>
        <div id="chat-box">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="send-message">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        document.getElementById("chat-toggle").addEventListener("click", function() {
            let chatBox = document.getElementById("chat-box");
            chatBox.style.display = chatBox.style.display === "none" ? "flex" : "none";
        });

        document.getElementById("send-message").addEventListener("click", function() {
            let inputField = document.getElementById("chat-input");
            let message = inputField.value;
            if (message) {
                document.getElementById("chat-messages").innerHTML += "<div>–í—ã: " + message + "</div>";
                inputField.value = "";
                fetch("{% url 'main_chat_assistant' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({ "message": message })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("chat-messages").innerHTML += "<div>–ë–æ—Ç: " + data.response + "</div>";
                });
            }
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                let cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}